<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Input Peserta Smart</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      :root {
        --primary: #ffd700;
        --bg: #121212;
        --surface: #1e1e1e;
        --text: #e0e0e0;
        --border: #333;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        padding-bottom: 100px;
      }

      .top-nav {
        background: rgba(18, 18, 18, 0.95);
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 50;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .back-btn {
        background: #333;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border: 1px solid #444;
      }
      .page-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }
      .container {
        padding: 15px;
        max-width: 600px;
        margin: 0 auto;
      }

      /* WA & Form Styles */
      .wa-box {
        background: linear-gradient(135deg, #075e54, #128c7e);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #25d366;
      }
      .wa-textarea {
        width: 100%;
        height: 100px;
        border-radius: 8px;
        border: none;
        padding: 10px;
        font-size: 0.85rem;
        background: rgba(255, 255, 255, 0.95);
        box-sizing: border-box;
        resize: vertical;
        font-family: monospace;
        color: #000;
      }
      .btn-extract {
        background: #25d366;
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: bold;
        margin-top: 10px;
        width: 100%;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
      }
      .btn-extract:active {
        transform: scale(0.98);
        background: #1da851;
      }

      .p-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
        animation: slideIn 0.3s ease;
      }
      .p-card-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        border-bottom: 1px dashed #333;
        padding-bottom: 8px;
      }
      .card-num {
        background: var(--primary);
        color: #000;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
      }
      .btn-del {
        background: transparent;
        border: none;
        color: #ff4d4d;
        cursor: pointer;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .form-group {
        margin-bottom: 10px;
      }
      .form-input {
        width: 100%;
        padding: 12px;
        background: #111;
        border: 1px solid #444;
        color: white;
        border-radius: 8px;
        box-sizing: border-box;
        outline: none;
        font-size: 1rem;
        color-scheme: dark;
      }
      .form-input:focus {
        border-color: var(--primary);
      }
      @media (max-width: 480px) {
        .form-grid {
          grid-template-columns: 1fr;
        }
      }

      .btn-item-select {
        width: 100%;
        background: #2a2a2a;
        border: 1px dashed var(--primary);
        color: var(--primary);
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 5px;
        font-weight: bold;
        display: flex;
        justify-content: center;
        gap: 8px;
        align-items: center;
      }
      .summary-text {
        font-size: 0.75rem;
        color: #aaa;
        margin-top: 5px;
        display: block;
        line-height: 1.4;
        white-space: pre-line;
      }

      .fab-add {
        width: 100%;
        background: #333;
        color: #fff;
        border: 1px dashed #666;
        padding: 15px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1rem;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
        align-items: center;
      }
      .bottom-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #1a1a1a;
        padding: 15px;
        border-top: 1px solid #333;
        display: flex;
        gap: 10px;
        z-index: 90;
      }
      .btn-save-all {
        flex: 1;
        background: var(--primary);
        color: #000;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
      }

      /* MODAL STYLES */
      #modalResult {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
        text-align: center;
      }
      .item-card {
        background: var(--surface);
        width: 100%;
        height: 100%;
        max-width: 500px;
        margin: 0 auto;
        border-radius: 16px;
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
      }
      .item-header {
        padding: 15px;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .item-body {
        padding: 10px;
        overflow-y: auto;
        flex-grow: 1;
      }

      .cat-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      .cat-btn {
        background: #252525;
        color: #fff;
        border: 1px solid #444;
        padding: 20px;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        text-align: center;
      }
      .cat-back {
        margin-bottom: 15px;
        background: #333;
        color: #fff;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
      }

      .item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 5px;
        border-bottom: 1px solid #2a2a2a;
      }
      .qty-control {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn-qty {
        width: 30px;
        height: 30px;
        background: #333;
        color: #fff;
        border: 1px solid #555;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .qty-val {
        width: 35px;
        text-align: center;
        font-size: 0.9rem;
        background: transparent;
        border: none;
        color: #fff;
      }

      /* STRUK */
      #receiptArea {
        position: absolute;
        top: 0;
        left: -9999px;
        width: 380px;
        background: #fff;
        color: #000;
        padding: 25px;
        font-family: "Courier New", monospace;
      }
      .r-header {
        text-align: center;
        border-bottom: 2px dashed #000;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .r-title {
        font-size: 1.4rem;
        font-weight: bold;
      }
      .r-item {
        margin-bottom: 15px;
        border-bottom: 1px dashed #ccc;
        padding-bottom: 15px;
      }
      .r-label {
        font-size: 0.8rem;
        color: #555;
      }
      .r-val {
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 4px;
      }
      .r-row-detail {
        margin-top: 5px;
        padding-top: 5px;
        border-top: 1px dotted #ddd;
      }
      .r-val-small {
        font-size: 0.85rem;
        color: #333;
        white-space: pre-wrap;
        line-height: 1.2;
      }
      .r-highlight {
        color: #000;
        font-weight: bold;
        font-size: 1rem;
        margin-top: 2px;
        display: block;
      }

      #resImg {
        max-width: 100%;
        max-height: 55vh;
        object-fit: contain;
        border: 4px solid #fff;
        border-radius: 8px;
        margin: 15px 0;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="top-nav">
      <a href="index.html" class="back-btn"
        ><i class="fas fa-arrow-left"></i
      ></a>
      <h2 class="page-title">Pendaftaran Peserta</h2>
      <div style="width: 40px"></div>
    </div>

    <div class="container">
      <div class="wa-box">
        <div style="color: #fff; font-weight: bold; margin-bottom: 5px">
          <i class="fab fa-whatsapp"></i> Isi Cepat dari WA
        </div>
        <textarea
          id="waRaw"
          class="wa-textarea"
          placeholder="Paste chat lengkap disini (Mendukung copy-paste pesan yang terpisah)..."
        ></textarea>
        <button onclick="parseWA()" class="btn-extract">
          <i class="fas fa-magic"></i> EKSTRAK DATA SEKARANG
        </button>
      </div>

      <div
        id="loadingInfo"
        style="text-align: center; padding: 20px; display: none; color: #ffd700"
      >
        <i class="fas fa-spinner fa-spin"></i> Sedang mengambil data server...
      </div>

      <div id="formsContainer"></div>

      <button class="fab-add" onclick="addParticipantRow()">
        <i class="fas fa-plus"></i> Tambah Peserta Lain
      </button>
    </div>

    <div class="bottom-bar">
      <button class="btn-save-all" id="btnSaveAll" onclick="saveAll()">
        <i class="fas fa-save"></i> SIMPAN & CETAK STRUK
      </button>
    </div>

    <div id="modalItems">
      <div class="item-card">
        <div class="item-header">
          <h3 style="margin: 0; color: var(--primary)" id="modalTitle">
            Pilih Barang
          </h3>
          <button
            onclick="closeModal()"
            style="
              background: none;
              border: none;
              color: #fff;
              font-size: 1.5rem;
            "
          >
            &times;
          </button>
        </div>
        <div class="item-body" id="itemBody"></div>
        <div
          style="padding: 15px; background: #1a1a1a; border-top: 1px solid #333"
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              color: #aaa;
              font-size: 0.8rem;
            "
          >
            <span>Total Belanja:</span>
            <span id="txtTotalReal" style="color: #fff">Rp 0</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin: 5px 0 15px;
              font-weight: bold;
              font-size: 1.1rem;
            "
          >
            <span id="lblTarget">Setoran:</span>
            <span id="txtTarget" style="color: var(--primary)">Rp 0 /hari</span>
          </div>
          <button onclick="confirmSelection()" class="btn-save-all">
            SELESAI PILIH
          </button>
        </div>
      </div>
    </div>

    <div id="modalResult">
      <h3 style="color: #fff">Pendaftaran Berhasil!</h3>
      <p style="color: #aaa; font-size: 0.9rem">
        Kirim bukti ini ke Mitra/Peserta
      </p>
      <img id="resImg" src="" />
      <div style="display: flex; gap: 10px; width: 100%; max-width: 350px">
        <button onclick="downloadStruk()" class="btn-save-all">
          <i class="fas fa-download"></i> Simpan Gambar
        </button>
        <button
          onclick="location.reload()"
          class="btn-save-all"
          style="background: #333"
        >
          Tutup
        </button>
      </div>
    </div>

    <div id="receiptArea">
      <div class="r-header">
        <div class="r-title">NIZAMI 2026</div>
        <div style="font-size: 0.9rem">BUKTI PENDAFTARAN</div>
        <div style="font-size: 0.7rem" id="rDate"></div>
      </div>
      <div id="rContent"></div>
      <div style="text-align: center; margin-top: 20px; font-size: 0.7rem">
        Simpan bukti ini sebagai arsip.<br />Terima Kasih.
      </div>
    </div>

    <script src="script.js"></script>
    <script>
      let formCount = 0;
      let masterMitra = [],
        masterPaket = [],
        masterBarang = [];
      let currentEditingRowId = null;
      let rowData = {};
      let currentMode = "normal";

      async function init(retryCount = 0) {
        const loading = document.getElementById("loadingInfo");
        loading.style.display = "block";
        try {
          const [mitra, paket, barang] = await Promise.all([
            fetchData("getMitra"),
            fetchData("getPaket"),
            fetchData("getBarang"),
          ]);
          masterMitra = Array.isArray(mitra) ? mitra : [];
          masterPaket = Array.isArray(paket) ? paket : [];
          masterBarang = Array.isArray(barang) ? barang : [];
          loading.style.display = "none";
          if (formCount === 0) addParticipantRow();
          else refreshDropdowns();
        } catch (e) {
          if (retryCount < 3) {
            loading.innerText = `Gagal memuat. Mencoba lagi (${retryCount + 1}/3)...`;
            setTimeout(() => init(retryCount + 1), 2000);
          } else {
            loading.innerHTML = `<span style="color:#ff6b6b">Gagal memuat data.</span> <button onclick="init()" style="background:#333; color:#fff; border:1px solid #fff; padding:5px 10px; border-radius:5px; margin-left:10px;">Coba Manual</button>`;
          }
        }
      }

      // ========================================================
      // FUNGSI EKSTRAK WA BARU (SUPER CERDAS)
      // ========================================================
      function parseWA() {
        const text = document.getElementById("waRaw").value;
        if (!text) return alert("Tempelkan teks WhatsApp dulu!");

        if (masterBarang.length === 0 || masterPaket.length === 0) {
          return alert(
            "Data Barang/Paket belum siap. Tunggu sebentar atau Refresh halaman.",
          );
        }

        // Pecah blok jika ada banyak tulisan "Nama:". Jika tidak, anggap semua text itu milik 1 orang.
        let entries = text.split(/(?=Nama\s*[:=])/i);
        entries = entries.filter((e) => e.trim().length > 5);
        if (entries.length === 0) entries = [text];

        let successCount = 0;

        // Bersihkan form kosong
        if (formCount === 1) {
          const fName = document.querySelector(".inp-nama");
          if (fName && fName.value === "") {
            removeRow(1);
            formCount = 0;
          }
        }

        entries.forEach((entry) => {
          // 1. Tangkap Profil Dasar
          const nmMatch = entry.match(/Nama\s*[:=]\s*([^\n]+)/i);
          const hpMatch = entry.match(
            /(?:HP|WA|No|Nomor)\s*[:=]\s*([\d\+\-\s]+)/i,
          );
          const alMatch = entry.match(/Alamat\s*[:=]\s*([^\n]+)/i);
          const mtMatch = entry.match(/Mitra\s*[:=]\s*([^\n]+)/i);

          let nm = nmMatch ? nmMatch[1].trim() : "";
          let hp = hpMatch ? hpMatch[1].replace(/\D/g, "") : "";
          let al = alMatch ? alMatch[1].trim() : "";
          let mt = mtMatch ? mtMatch[1].trim() : "";

          // 2. Deteksi Paket (Bisa Lebih Dari 1 Paket)
          let matchedPakets = [];

          // Cari nama paket langsung dari database yang disebut di teks
          masterPaket.forEach((p) => {
            const safeName = p.nama.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&"); // Bersihkan simbol regex
            const regex = new RegExp(safeName, "i");
            if (regex.test(entry)) {
              matchedPakets.push(p);
            }
          });

          // Fallback: Jika tidak terdeteksi pakai nama langsung, gunakan Regex Paket:
          if (matchedPakets.length === 0) {
            const pkRegex = entry.match(/Paket\s*[:=]\s*([^\n]+)/i);
            if (pkRegex) {
              const found = masterPaket.find((p) =>
                p.nama.toLowerCase().includes(pkRegex[1].trim().toLowerCase()),
              );
              if (found) matchedPakets.push(found);
            }
          }

          // Jika tetap kosong paketnya, siapkan 1 wadah dummy untuk render form saja
          if (matchedPakets.length === 0) matchedPakets.push({ nama: "" });

          // 3. Render Form Sesuai Jumlah Paket yang Dipilih
          matchedPakets.forEach((paket) => {
            // Abaikan jika tidak ada nama DAN tidak ada paket yang ditemukan (Pesan sampah)
            if (!nm && !paket.nama) return;

            addParticipantRow();
            const rowId = formCount;
            const row = document.getElementById(`row_${rowId}`);

            // Isi Data Diri
            row.querySelector(".inp-nama").value = nm;
            if (hp) row.querySelector(".inp-hp").value = hp;
            if (al) row.querySelector(".inp-alamat").value = al;
            if (mt) setDropdownByText(row.querySelector(".inp-mitra"), mt);

            // Isi Paket & Barang
            if (paket.nama) {
              const selPaket = row.querySelector(".inp-paket");
              const found = setDropdownByText(selPaket, paket.nama);

              if (found) {
                checkPaket(selPaket, rowId); // Buka keranjang jika itu Sembako/Kue
                smartExtractItems(entry, rowId); // Jalankan Ekstrak Barang
              }
            }
            successCount++;
          });
        });

        if (successCount > 0) {
          document.getElementById("waRaw").value = "";
          alert(
            `Berhasil mengekstrak ${successCount} form pendaftaran! Silakan periksa kembali rincian dan nama yang mungkin kosong.`,
          );
        } else {
          alert(
            "Sistem tidak mendeteksi data yang valid. Silakan input manual.",
          );
        }
      }

      function smartExtractItems(textEntry, rowId) {
        if (!rowData[`row_${rowId}`])
          rowData[`row_${rowId}`] = { items: {}, total: 0 };
        const currentRowData = rowData[`row_${rowId}`];
        let matchCount = 0;

        // Pecah teks berdasarkan enter (baris baru)
        const lines = textEntry.split("\n");

        lines.forEach((line) => {
          const lowerLine = line.toLowerCase();

          for (let b of masterBarang) {
            const bNameLower = b.nama.toLowerCase();

            // Jika nama barang disebut di baris ini
            if (lowerLine.includes(bNameLower)) {
              let qty = 1;

              // Teknik 1: Angka dalam kurung (cth: (2 Bal), (1 Karung))
              const parenMatch = line.match(/\(\s*(\d+)\s*[a-zA-Z]*\s*\)/);
              // Teknik 2: Angka diikuti X (cth: 1x, 2 x)
              const xMatch = line.match(/(\d+)\s*x/i);
              // Teknik 3: Angka setelah strip/bullet di awal (cth: - 2 Beras Super)
              const startMatch = line.match(/^(?:-|\*|\•|\d+\.)?\s*(\d+)/);

              if (parenMatch) qty = parseInt(parenMatch[1]);
              else if (xMatch) qty = parseInt(xMatch[1]);
              else if (startMatch) qty = parseInt(startMatch[1]);

              if (currentRowData.items[b.nama]) {
                currentRowData.items[b.nama] += qty;
              } else {
                currentRowData.items[b.nama] = qty;
              }
              matchCount++;
              break; // Jika sudah ketemu 1 barang di baris ini, lanjut ke baris berikutnya
            }
          }
        });

        if (matchCount > 0) {
          recalculateRowTotal(rowId);
        }
      }

      // ========================================================
      // FUNGSI LAINNYA (TIDAK BERUBAH)
      // ========================================================
      function setDropdownByText(selectElement, textToFind) {
        const cleanText = textToFind.toLowerCase().trim();
        for (let i = 0; i < selectElement.options.length; i++) {
          const optText = selectElement.options[i].text.toLowerCase();
          if (optText.includes(cleanText) || cleanText.includes(optText)) {
            selectElement.selectedIndex = i;
            return true;
          }
        }
        return false;
      }

      function recalculateRowTotal(rowId) {
        const data = rowData[`row_${rowId}`];
        const selectEl = document.querySelector(`#row_${rowId} .inp-paket`);
        const mode = selectEl.dataset.mode;

        let total = 0;
        let itemsList = [];
        let itemsForDB = {};

        let divisor = 1;
        let labelSatuan = "";
        if (mode === "mingguan") {
          divisor = 40;
          labelSatuan = " /mgg";
        } else if (mode === "cookies") {
          divisor = 330;
          labelSatuan = " /hr";
        }

        for (const [name, qty] of Object.entries(data.items)) {
          const itemMaster = masterBarang.find((b) => b.nama === name);
          if (itemMaster) {
            const subtotal = itemMaster.harga * qty;
            total += subtotal;
            const cicilan = Math.ceil(subtotal / divisor);
            const txtCicil =
              divisor > 1 ? `${formatRupiah(cicilan)}${labelSatuan}` : "";
            itemsList.push(`${name} (${qty}) ${txtCicil}`);
            itemsForDB[name] = qty;
          }
        }

        data.total = total;

        let displayTotal = formatRupiah(total);
        if (mode === "mingguan")
          displayTotal += ` (Setoran: ${formatRupiah(Math.ceil(total / 40))} /mgg)`;
        else if (mode === "cookies")
          displayTotal += ` (Setoran: ${formatRupiah(Math.ceil(total / 330))} /hr)`;

        document.getElementById(`btnText_${rowId}`).innerHTML =
          `<i class="fas fa-check-circle" style="color:#4ade80"></i> ${itemsList.length} Item (Otomatis)`;
        document.getElementById(`summary_${rowId}`).innerText =
          itemsList.join(", ") + `\nTotal: ${displayTotal}`;

        document.getElementById(`valHarga_${rowId}`).value = total;
        document.getElementById(`valRincian_${rowId}`).value =
          itemsList.join("\n");
        document.getElementById(`valItemsJson_${rowId}`).value =
          JSON.stringify(itemsForDB);
      }

      function addParticipantRow() {
        formCount++;
        const html = `
            <div class="p-card" id="row_${formCount}">
                <div class="p-card-header">
                    <span class="card-num">Peserta #${formCount}</span>
                    <button class="btn-del" onclick="removeRow(${formCount})"><i class="fas fa-trash"></i></button>
                </div>
                <div class="form-group"><input type="text" class="form-input inp-nama" placeholder="Nama Lengkap"></div>
                <div class="form-grid">
                    <input type="number" class="form-input inp-hp" placeholder="No HP/WA">
                    <input type="text" class="form-input inp-alamat" placeholder="Alamat">
                </div>
                <div class="form-grid" style="margin-top:10px;">
                    <select class="form-input inp-mitra">${generateMitraOptions()}</select>
                    <select class="form-input inp-paket" onchange="checkPaket(this, ${formCount})">${generatePaketOptions()}</select>
                </div>
                <div id="customArea_${formCount}" style="display:none; margin-top:10px;">
                    <button class="btn-item-select" onclick="openItemModal(${formCount})">
                        <i class="fas fa-shopping-basket"></i> <span id="btnText_${formCount}">Pilih Barang</span>
                    </button>
                    <small class="summary-text" id="summary_${formCount}"></small>
                    <input type="hidden" class="inp-harga-custom" id="valHarga_${formCount}" value="0">
                    <input type="hidden" class="inp-rincian" id="valRincian_${formCount}" value="">
                    <input type="hidden" class="inp-items-json" id="valItemsJson_${formCount}" value="">
                </div>
            </div>`;
        document
          .getElementById("formsContainer")
          .insertAdjacentHTML("beforeend", html);

        if (formCount > 1) {
          const prev = document.getElementById(`row_${formCount - 1}`);
          if (prev) {
            const prevMitra = prev.querySelector(".inp-mitra").value;
            document
              .getElementById(`row_${formCount}`)
              .querySelector(".inp-mitra").value = prevMitra;
          }
        }
      }

      function generateMitraOptions() {
        if (masterMitra.length === 0)
          return '<option value="">(Data Kosong)</option>';
        let opts =
          '<option value="">Pilih Mitra...</option><option value="Pusat">Pusat (Langsung)</option>';
        masterMitra.forEach((m) => {
          if (m.nama !== "Pusat")
            opts += `<option value="${m.nama}">${m.nama}</option>`;
        });
        return opts;
      }

      function generatePaketOptions() {
        if (masterPaket.length === 0)
          return '<option value="">(Data Kosong)</option>';
        let opts = '<option value="">Pilih Paket...</option>';
        masterPaket.forEach(
          (p) => (opts += `<option value="${p.nama}">${p.nama}</option>`),
        );
        return opts;
      }

      function refreshDropdowns() {
        document.querySelectorAll(".inp-mitra").forEach((el) => {
          const oldVal = el.value;
          el.innerHTML = generateMitraOptions();
          el.value = oldVal;
        });
        document.querySelectorAll(".inp-paket").forEach((el) => {
          const oldVal = el.value;
          el.innerHTML = generatePaketOptions();
          el.value = oldVal;
        });
      }

      function removeRow(id) {
        const el = document.getElementById(`row_${id}`);
        if (el) el.remove();
        delete rowData[`row_${id}`];
      }

      function checkPaket(selectEl, rowId) {
        const val = selectEl.value.toLowerCase();
        const area = document.getElementById(`customArea_${rowId}`);
        const btn = document.getElementById(`btnText_${rowId}`);

        document.getElementById(`valHarga_${rowId}`).value = 0;
        document.getElementById(`valRincian_${rowId}`).value = "";
        document.getElementById(`valItemsJson_${rowId}`).value = "";
        document.getElementById(`summary_${rowId}`).innerText = "";
        if (!rowData[`row_${rowId}`])
          rowData[`row_${rowId}`] = { items: {}, total: 0 };
        rowData[`row_${rowId}`].items = {};
        rowData[`row_${rowId}`].total = 0;

        if (val.includes("mingguan")) {
          area.style.display = "block";
          btn.innerText = "Pilih Sembako (Mingguan)";
          selectEl.dataset.mode = "mingguan";
        } else if (val.includes("cookies")) {
          area.style.display = "block";
          btn.innerText = "Pilih Kue (Cookies)";
          selectEl.dataset.mode = "cookies";
        } else {
          area.style.display = "none";
          selectEl.dataset.mode = "normal";
        }
      }

      function openItemModal(rowId) {
        if (masterBarang.length === 0)
          return alert("Data barang belum termuat. Silakan refresh halaman.");
        currentEditingRowId = rowId;
        const row = document.getElementById(`row_${rowId}`);
        const mode = row.querySelector(".inp-paket").dataset.mode;
        currentMode = mode;
        document.getElementById("modalItems").style.display = "flex";
        if (mode === "mingguan") renderCategories();
        else if (mode === "cookies") renderItems("Cookies");
        else renderItems(null);
        updateModalTotal();
      }

      function renderCategories() {
        const body = document.getElementById("itemBody");
        document.getElementById("modalTitle").innerText = "Pilih Kategori";
        const categories = [
          ...new Set(masterBarang.map((item) => item.kategori)),
        ];
        let html = `<div class="cat-grid">`;
        categories.forEach((cat) => {
          if (cat)
            html += `<div class="cat-btn" onclick="renderItems('${cat}')">${cat}</div>`;
        });
        html += `</div>`;
        body.innerHTML = html;
      }

      function renderItems(filterCategory) {
        const body = document.getElementById("itemBody");
        document.getElementById("modalTitle").innerText = filterCategory
          ? filterCategory
          : "Pilih Barang";
        let html = "";
        if (currentMode === "mingguan" && filterCategory)
          html += `<button class="cat-back" onclick="renderCategories()"><i class="fas fa-arrow-left"></i> Kembali ke Kategori</button>`;
        const savedItems =
          (rowData[`row_${currentEditingRowId}`] || {}).items || {};

        masterBarang.forEach((b) => {
          let show = true;
          if (filterCategory && b.kategori !== filterCategory) show = false;
          if (show) {
            const qty = savedItems[b.nama] || 0;
            html += `
                    <div class="item-row">
                        <div>
                            <div style="font-weight:bold; color:#fff;">${b.nama}</div>
                            <div style="font-size:0.75rem; color:#aaa;">${formatRupiah(b.harga)} / ${b.satuan}</div>
                        </div>
                        <div class="qty-control">
                            <button class="btn-qty" onclick="changeQty(this, -1)">-</button>
                            <input type="number" readonly class="qty-val" data-name="${b.nama}" data-price="${b.harga}" value="${qty}">
                            <button class="btn-qty" onclick="changeQty(this, 1)">+</button>
                        </div>
                    </div>`;
          }
        });
        body.innerHTML = html;
      }

      function changeQty(btn, change) {
        const input = btn.parentElement.querySelector(".qty-val");
        let val = parseInt(input.value) + change;
        if (val < 0) val = 0;
        input.value = val;
        const name = input.dataset.name;
        if (!rowData[`row_${currentEditingRowId}`])
          rowData[`row_${currentEditingRowId}`] = { items: {}, total: 0 };
        rowData[`row_${currentEditingRowId}`].items[name] = val;
        updateModalTotal();
      }

      function updateModalTotal() {
        let total = 0;
        const currentRowData = rowData[`row_${currentEditingRowId}`] || {
          items: {},
        };
        for (const [name, qty] of Object.entries(currentRowData.items)) {
          const item = masterBarang.find((b) => b.nama === name);
          if (item) total += item.harga * qty;
        }
        document.getElementById("txtTotalReal").innerText = formatRupiah(total);
        let targetLabel = "Total:";
        let targetVal = formatRupiah(total);
        if (currentMode === "mingguan") {
          targetLabel = "Setoran per Minggu (40x):";
          targetVal = formatRupiah(Math.ceil(total / 40));
        } else if (currentMode === "cookies") {
          targetLabel = "Setoran per Hari (330x):";
          targetVal = formatRupiah(Math.ceil(total / 330));
        }
        document.getElementById("lblTarget").innerText = targetLabel;
        document.getElementById("txtTarget").innerText = targetVal;
        currentRowData.total = total;
      }

      function confirmSelection() {
        recalculateRowTotal(currentEditingRowId);
        closeModal();
      }
      function closeModal() {
        document.getElementById("modalItems").style.display = "none";
      }

      async function saveAll() {
        const cards = document.querySelectorAll(".p-card");
        if (cards.length === 0) return;
        if (!confirm(`Simpan ${cards.length} data peserta?`)) return;

        const btn = document.getElementById("btnSaveAll");
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMPROSES...';
        btn.disabled = true;
        let successData = [];

        for (const card of cards) {
          const nama = card.querySelector(".inp-nama").value;
          const hp = card.querySelector(".inp-hp").value;
          const alamat = card.querySelector(".inp-alamat").value;
          const mitra = card.querySelector(".inp-mitra").value;
          const paket = card.querySelector(".inp-paket").value;
          let harga = 0,
            rincian = "",
            items_json = "";

          const customArea = card.querySelector('div[id^="customArea_"]');
          if (customArea && customArea.style.display !== "none") {
            harga = card.querySelector(".inp-harga-custom").value;
            rincian = card.querySelector(".inp-rincian").value;
            items_json = card.querySelector(".inp-items-json").value;
          }

          let setoranText = "";
          if (harga > 0) {
            if (paket.toLowerCase().includes("mingguan"))
              setoranText = formatRupiah(Math.ceil(harga / 40)) + " /minggu";
            else if (paket.toLowerCase().includes("cookies"))
              setoranText = formatRupiah(Math.ceil(harga / 330)) + " /hari";
          }

          if (nama && mitra && paket) {
            try {
              const res = await fetchData("tambahPeserta", {
                nama,
                hp,
                alamat,
                mitra,
                paket,
                harga,
                rincian,
                items_json: items_json,
              });
              if (res.success) {
                successData.push({
                  nama,
                  mitra,
                  paket,
                  id: res.id,
                  rincian,
                  setoran: setoranText,
                });
                card.remove();
              }
            } catch (e) {}
          }
        }

        btn.innerHTML = '<i class="fas fa-save"></i> SIMPAN & CETAK STRUK';
        btn.disabled = false;
        if (successData.length > 0) generateReceipt(successData);
        else alert("Gagal menyimpan. Cek koneksi atau data input.");
      }

      async function generateReceipt(data) {
        const rContent = document.getElementById("rContent");
        document.getElementById("rDate").innerText = new Date().toLocaleString(
          "id-ID",
        );
        rContent.innerHTML = "";

        data.forEach((d) => {
          let extraHtml = "";
          if (d.rincian) {
            let formatRincian = d.rincian
              .split("\n")
              .map((item) => `• ${item}`)
              .join("<br>");
            extraHtml += `<div class="r-row-detail"><div class="r-label">Rincian Barang:</div><div class="r-val-small" style="margin-top:5px; line-height:1.5;">${formatRincian}</div></div>`;
          }
          if (d.setoran)
            extraHtml += `<div class="r-item" style="border-bottom:none; margin-bottom:5px;"><div class="r-label">Target Setoran:</div><span class="r-highlight">${d.setoran}</span></div>`;

          rContent.innerHTML += `
                <div class="r-item">
                    <div class="r-label">Nama:</div><div class="r-val">${d.nama}</div>
                    <div class="r-label">ID Peserta:</div><div class="r-val">${d.id}</div>
                    <div class="r-label">Paket:</div><div class="r-val">${d.paket}</div>
                    <div class="r-label">Mitra:</div><div class="r-val">${d.mitra}</div>
                    ${extraHtml}
                </div>`;
        });

        const canvas = await html2canvas(
          document.getElementById("receiptArea"),
          { scale: 2 },
        );
        document.getElementById("resImg").src = canvas.toDataURL("image/png");
        document.getElementById("modalResult").style.display = "flex";
        window.currentStruk = canvas.toDataURL("image/png");

        if (document.querySelectorAll(".p-card").length === 0)
          addParticipantRow();
      }

      function downloadStruk() {
        const link = document.createElement("a");
        link.download = "PENDAFTARAN-" + Date.now() + ".png";
        link.href = window.currentStruk;
        link.click();
      }

      init();
    </script>
  </body>
</html>
