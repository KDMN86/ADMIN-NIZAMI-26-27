<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Massal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary: #FFD700; --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; --border: #333; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 0; margin: 0; padding-bottom: 120px; }
        
        /* Header */
        header { 
            background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(5px);
            padding: 15px; position: sticky; top: 0; z-index: 50; 
            border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center;
        }
        .back-btn { background: #333; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; flex-shrink: 0; }
        .search-bar { width: 100%; padding: 12px 20px; border-radius: 25px; border: 1px solid #444; background: #222; color: white; outline: none; font-size: 1rem; }
        .search-bar:focus { border-color: var(--primary); }

        /* List */
        #containerList { padding: 15px; }
        
        .card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .card.active { border: 1px solid var(--primary); background: #222; }
        .card.active::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary);
        }
        
        .p-info h4 { margin: 0; font-size: 1rem; color: #fff; }
        .p-info .badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: var(--primary); border: 1px solid #444; margin-left: 5px; }
        .p-detail { font-size: 0.8rem; color: #aaa; margin-top: 4px; display: block; }
        .p-price { color: #4caf50; font-weight: bold; font-size: 0.85rem; }

        .counter-box {
            display: flex; align-items: center; gap: 8px;
            background: #000; padding: 4px; border-radius: 8px; border: 1px solid #333;
        }
        .btn-qty { width: 32px; height: 32px; background: #333; border: none; color: white; border-radius: 6px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        .btn-qty:active { transform: scale(0.9); }
        
        /* Update Input agar terlihat bisa diedit */
        .input-qty { 
            width: 45px; text-align: center; background: #111; 
            border: 1px solid #444; border-radius: 4px;
            color: var(--primary); font-weight: bold; font-size: 1.1rem; 
            padding: 2px;
            -moz-appearance: textfield; /* Hilangkan spinner di Firefox */
        }
        .input-qty::-webkit-outer-spin-button,
        .input-qty::-webkit-inner-spin-button {
            -webkit-appearance: none; margin: 0; /* Hilangkan spinner di Chrome */
        }
        .input-qty:focus { border-color: var(--primary); outline: none; }

        /* Bottom Action */
        .bottom-action {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #1a1a1a; padding: 15px 20px;
            border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
            z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .total-box small { display: block; color: #888; font-size: 0.8rem; }
        .total-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .btn-save {
            background: var(--primary); color: #000; font-weight: bold;
            padding: 12px 25px; border-radius: 30px; border: none;
            font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .btn-save:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* Struk (Hidden) */
        #receiptArea {
            position: fixed; top: -9999px; left: -9999px;
            width: 380px; background: #fff; color: #000;
            padding: 25px; font-family: 'Courier New', monospace;
            border: 1px solid #000;
        }
        .r-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
        .r-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .r-sub { font-size: 12px; color: #444; margin-left: 10px; font-style: italic; }
        .r-total { border-top: 2px dashed #000; margin-top: 15px; padding-top: 10px; font-weight: bold; font-size: 16px; }

        /* Modal */
        #modalResult {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200;
            flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        #previewImg img { max-width: 100%; height: auto; border: 10px solid #fff; border-radius: 5px; margin: 20px 0; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
        <input type="text" id="cari" class="search-bar" placeholder="ðŸ” Cari Mitra (cth: Pusat)..." onkeyup="cariPeserta(this.value)" autocomplete="off">
    </header>

    <div id="containerList">
        <div style="text-align:center; color:#555; margin-top:80px;">
            <i class="fas fa-wallet" style="font-size:3rem; margin-bottom:15px; opacity:0.5;"></i>
            <p>Silakan cari nama Mitra atau Peserta<br>untuk input setoran massal.</p>
        </div>
    </div>

    <div id="receiptArea">
        <div class="r-header">
            <h2 style="margin:0;">NIZAMI 2026</h2>
            <span>BUKTI SETORAN TABUNGAN</span><br>
            <span id="rDate" style="font-size:12px;">-</span>
        </div>
        <div id="rItems"></div>
        <div class="r-row r-total">
            <span>TOTAL DISETOR</span>
            <span id="rGrandTotal">Rp 0</span>
        </div>
        <div style="text-align:center; margin-top:30px; font-size:12px;">
            Terima Kasih<br>Admin Nizami
        </div>
    </div>

    <div class="bottom-action">
        <div class="total-box">
            <small id="countItem">0 Transaksi</small>
            <div class="total-val" id="totalMoney">Rp 0</div>
        </div>
        <button class="btn-save" id="btnProses" onclick="prosesSemua()" disabled>
            SIMPAN & CETAK <i class="fas fa-print"></i>
        </button>
    </div>

    <div id="modalResult">
        <h3 style="color:var(--primary); margin:0;">Transaksi Berhasil!</h3>
        <small style="color:#aaa;">Silakan simpan bukti di bawah ini</small>
        
        <div id="previewImg"></div>
        
        <div style="display:flex; gap:10px; width:100%; max-width:350px;">
            <button onclick="downloadBukti()" class="btn-save" style="flex:1; justify-content:center;">
                <i class="fas fa-download"></i> DOWNLOAD
            </button>
            <button onclick="location.reload()" class="btn-save" style="flex:1; justify-content:center; background:#333; color:#fff;">
                SELESAI
            </button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let debounce;
        let activeResults = []; 
        let cart = {}; // Format: { id: { qty: 0, data: {...} } }

        function cariPeserta(q) {
            clearTimeout(debounce);
            const container = document.getElementById('containerList');
            
            if(q.length < 3) return;
            container.innerHTML = '<div style="text-align:center; color:#aaa; padding:20px;">Mencari data...</div>';

            debounce = setTimeout(async () => {
                const res = await fetchData('cariPeserta', {q: q});
                container.innerHTML = '';
                activeResults = res || [];

                if(activeResults.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">Data tidak ditemukan<br><small>Coba kata kunci lain</small></div>';
                    return;
                }

                activeResults.forEach(p => {
                    const inCart = cart[p.id];
                    const qty = inCart ? inCart.qty : 0;
                    const activeClass = qty > 0 ? 'active' : '';
                    const nextFreq = p.freq + 1;
                    
                    // Kita gunakan formatRupiah untuk menampilkan harga satuan yang benar (dari backend)
                    const html = `
                    <div class="card ${activeClass}" id="card-${p.id}">
                        <div class="p-info">
                            <h4>${p.nama} <span class="badge">${p.mitra}</span></h4>
                            <span class="p-detail">${p.paket}</span>
                            <span class="p-detail" style="color:#888;">
                                Tabungan ke: <b style="color:#fff;">${nextFreq}</b> (Sebelumnya: ${p.freq}x)
                            </span>
                            <span class="p-price">Nominal: ${formatRupiah(p.harga)}</span>
                        </div>
                        <div class="counter-box">
                            <button class="btn-qty" onclick="updateQty('${p.id}', -1)">-</button>
                            
                            <input type="number" class="input-qty" id="qty-${p.id}" value="${qty}" 
                                   oninput="manualInput('${p.id}', this.value)" placeholder="0">
                            
                            <button class="btn-qty" onclick="updateQty('${p.id}', 1)">+</button>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });
            }, 500);
        }

        // FUNGSI BARU: Menangani ketikan manual di keyboard
        function manualInput(id, valStr) {
            let val = parseInt(valStr);
            if(isNaN(val) || val < 0) val = 0;
            updateCartLogic(id, val);
        }

        // Update tombol + dan -
        function updateQty(id, change) {
            const input = document.getElementById(`qty-${id}`);
            let currentVal = parseInt(input.value || 0);
            let newVal = currentVal + change;
            
            if(newVal < 0) newVal = 0;
            input.value = newVal; // Update tampilan

            updateCartLogic(id, newVal);
        }

        // LOGIKA UPDATE CART (Dipisah agar rapi)
        function updateCartLogic(id, val) {
            const card = document.getElementById(`card-${id}`);
            
            // Cari data peserta (Prioritas dari hasil pencarian, kalau gak ada cari di cart)
            let pData = activeResults.find(p => p.id === id);
            if (!pData && cart[id]) pData = cart[id].data;
            
            if(!pData) return;

            if(val > 0) {
                cart[id] = { qty: val, data: pData }; 
                if(card) card.classList.add('active');
            } else {
                delete cart[id];
                if(card) card.classList.remove('active');
            }

            updateSummary();
        }

        function updateSummary() {
            let count = 0;
            let total = 0;
            
            for(let key in cart) {
                const item = cart[key];
                // Pastikan harga ada (default 0 jika error)
                const harga = item.data.harga || 0;
                
                count += item.qty; 
                total += (item.qty * harga);
            }

            document.getElementById('countItem').innerText = Object.keys(cart).length + " Peserta (" + count + "x)";
            document.getElementById('totalMoney').innerText = formatRupiah(total);
            
            // Tombol aktif HANYA JIKA total uang > 0
            const btn = document.getElementById('btnProses');
            if (total > 0) {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            } else {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
            }
        }

        async function prosesSemua() {
            if(!confirm("Sudah yakin datanya benar?")) return;

            const btn = document.getElementById('btnProses');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMPROSES...';
            btn.disabled = true;

            const rList = document.getElementById('rItems');
            rList.innerHTML = '';
            document.getElementById('rDate').innerText = new Date().toLocaleString('id-ID');
            
            let grandTotal = 0;
            let successCount = 0;

            // Loop semua item di Cart
            for (let id in cart) {
                const item = cart[id];
                const p = item.data;
                const nominal = item.qty * p.harga;
                
                if(nominal > 0) {
                    try {
                        // Kirim ke Server
                        await fetchData('inputSetoran', {idPeserta: id, nominal: nominal});
                        
                        rList.innerHTML += `
                        <div class="r-row" style="margin-bottom:2px;">
                            <span>${p.nama}</span>
                            <span>${formatRupiah(nominal)}</span>
                        </div>
                        <div class="r-row" style="margin-bottom:8px; color:#555; font-size:12px;">
                            <span style="margin-left:10px;">${item.qty}x @ ${formatRupiah(p.harga)} (Tabungan ke-${p.freq + item.qty})</span>
                        </div>`;
                        
                        grandTotal += nominal;
                        successCount++;
                    } catch(e) {
                        console.error("Gagal stor: " + p.nama);
                    }
                }
            }

            document.getElementById('rGrandTotal').innerText = formatRupiah(grandTotal);

            if(successCount > 0) {
                // Generate Gambar Struk
                const canvas = await html2canvas(document.getElementById('receiptArea'), {scale: 2});
                const imgData = canvas.toDataURL("image/png");
                
                document.getElementById('previewImg').innerHTML = `<img src="${imgData}">`;
                document.getElementById('modalResult').style.display = 'flex';
                window.currentImgData = imgData;
            } else {
                alert("Gagal memproses transaksi. Periksa koneksi atau harga paket.");
                location.reload();
            }
        }

        function downloadBukti() {
            const link = document.createElement('a');
            link.download = 'NIZAMI-STRUK-' + Date.now() + '.png';
            link.href = window.currentImgData;
            link.click();
        }
    </script>
</body>
</html>
