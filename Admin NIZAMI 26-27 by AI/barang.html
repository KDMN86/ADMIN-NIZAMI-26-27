<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Master Barang</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* MANTRA ANTI-BOCOR (Wajib ada agar elemen tidak melewati batas layar) */
      * {
        box-sizing: border-box;
      }

      :root {
        --primary: #ffd700;
        --bg: #121212;
        --surface: #1e1e1e;
        --text: #e0e0e0;
        --border: #333;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        padding-bottom: 90px;
        overflow-x: hidden; /* Mencegah layar tergeser ke kanan */
      }

      /* HEADER & SEARCH AREA */
      .header-area {
        background: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(10px);
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 50;
        border-bottom: 1px solid var(--border);
      }
      .top-nav {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 12px;
      }
      .back-btn {
        background: #333;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        border: none;
        flex-shrink: 0;
      }
      .page-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .filter-group {
        display: flex;
        gap: 10px;
      }
      .search-input {
        flex: 2;
        padding: 10px 15px;
        background: #222;
        border: 1px solid #444;
        color: white;
        border-radius: 10px;
        outline: none;
        font-size: 0.9rem;
        width: 100%;
      }
      .filter-select {
        flex: 1;
        padding: 10px;
        background: #222;
        border: 1px solid #444;
        color: var(--primary);
        border-radius: 10px;
        outline: none;
        font-size: 0.85rem;
        text-align: center;
        font-weight: bold;
        width: 100%;
      }

      /* ITEM LIST */
      #listArea {
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        width: 100%;
      }

      .item-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 15px;
        display: flex;
        gap: 12px;
        position: relative;
        width: 100%;
      }
      .item-img {
        width: 70px;
        height: 70px;
        border-radius: 10px;
        background: #111;
        border: 1px dashed #444;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
      }
      .item-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .item-info {
        flex-grow: 1;
        min-width: 0; /* PENTING: Mencegah flexbox membesar melewati batas */
      }
      .item-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 5px;
      }
      .item-name {
        margin: 0;
        font-size: 0.95rem;
        color: #fff;
        font-weight: 600;
        padding-right: 20px;
        line-height: 1.3;
        word-wrap: break-word;
      }
      .badge-cat {
        background: rgba(255, 255, 255, 0.1);
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.65rem;
        color: #aaa;
        border: 1px solid #444;
        white-space: nowrap;
        height: fit-content;
        display: inline-block;
        margin-bottom: 8px;
      }

      .btn-del-mini {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        color: #ff6b81;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 5px;
      }

      .used-in {
        background: #111;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 0.7rem;
        color: #888;
        margin-bottom: 10px;
        border-left: 2px solid #555;
        line-height: 1.4;
      }
      .used-in b {
        color: #ccc;
      }
      .used-in .hl {
        color: #48dbfb;
        font-weight: 600;
      }

      /* DIUBAH: Jarak grid diperkecil agar tidak terpotong di HP */
      .price-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-bottom: 10px;
      }
      .p-box {
        background: #1a1a1a;
        border: 1px solid #333;
        padding: 6px 8px;
        border-radius: 8px;
        min-width: 0; /* PENTING: Mencegah box harga melebar */
      }
      .p-label {
        font-size: 0.6rem;
        color: #888;
        display: block;
        text-transform: uppercase;
        margin-bottom: 2px;
      }
      /* DIUBAH: Ukuran font harga disesuaikan */
      .p-val {
        font-size: 0.85rem;
        font-weight: bold;
        color: #fff;
        word-break: break-word;
      }
      .p-val.jual {
        color: var(--primary);
      }

      .btn-edit-full {
        width: 100%;
        background: #222;
        color: #fff;
        border: 1px solid #555;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.8rem;
        display: flex;
        justify-content: center;
        gap: 8px;
        align-items: center;
      }
      .btn-edit-full:active {
        background: var(--primary);
        color: #000;
      }

      /* FLOATING ADD BUTTON & MODAL */
      .fab-add {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary);
        color: #000;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        cursor: pointer;
        z-index: 90;
        border: none;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 100;
        align-items: center;
        justify-content: center;
        padding: 15px;
        backdrop-filter: blur(5px);
      }
      .modal-card {
        background: var(--surface);
        width: 100%;
        max-width: 400px;
        padding: 20px;
        border-radius: 16px;
        border: 1px solid var(--border);
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .m-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: none;
        color: #888;
        font-size: 1.5rem;
        cursor: pointer;
      }
      .modal-title {
        margin-top: 0;
        color: var(--primary);
        font-size: 1.1rem;
        margin-bottom: 15px;
        padding-right: 20px;
      }

      .form-group {
        margin-bottom: 12px;
      }
      .form-group label {
        display: block;
        color: #aaa;
        margin-bottom: 5px;
        font-size: 0.8rem;
      }
      .form-input {
        width: 100%;
        padding: 10px 12px;
        background: #111;
        border: 1px solid #444;
        color: white;
        border-radius: 8px;
        box-sizing: border-box;
        outline: none;
        font-size: 0.95rem;
      }
      .form-input:focus {
        border-color: var(--primary);
      }

      .btn-full {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: #000;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
      }

      /* UPLOAD FOTO AREA */
      .foto-upload-box {
        border: 2px dashed #555;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        margin-bottom: 15px;
        cursor: pointer;
        background: #111;
        position: relative;
        overflow: hidden;
      }
      .foto-upload-box img {
        max-height: 100px;
        object-fit: contain;
        display: none;
        margin: 0 auto;
      }
      .foto-upload-box .placeholder {
        color: #888;
        font-size: 0.85rem;
      }
      .foto-upload-box .placeholder i {
        font-size: 2rem;
        margin-bottom: 10px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="header-area">
      <div class="top-nav">
        <a href="index.html" class="back-btn"
          ><i class="fas fa-arrow-left"></i
        ></a>
        <h2 class="page-title">Master Barang</h2>
      </div>
      <div class="filter-group">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="ðŸ” Cari barang..."
          onkeyup="filterLokal()"
        />
        <select id="catFilter" class="filter-select" onchange="filterLokal()">
          <option value="">Kategori</option>
        </select>
      </div>
    </div>

    <div id="listArea">
      <div style="text-align: center; padding: 50px; color: #555">
        <i
          class="fas fa-spinner fa-spin fa-2x"
          style="color: var(--primary); margin-bottom: 10px"
        ></i
        ><br />Memuat data...
      </div>
    </div>

    <button class="fab-add" onclick="bukaModalEdit(null)">
      <i class="fas fa-plus"></i>
    </button>

    <div id="modalForm" class="modal">
      <div class="modal-card">
        <button class="m-close" onclick="tutupModal()">&times;</button>
        <h2 class="modal-title" id="mTitle">Tambah Barang</h2>

        <input type="hidden" id="eNamaLama" />
        <input
          type="file"
          id="fileInput"
          accept="image/*"
          style="display: none"
          onchange="previewImage(event)"
        />

        <div
          class="foto-upload-box"
          onclick="document.getElementById('fileInput').click()"
        >
          <div class="placeholder" id="fotoPlaceholder">
            <i class="fas fa-camera"></i> Ketuk untuk upload foto
          </div>
          <img id="fotoPreview" src="" />
        </div>

        <div class="form-group">
          <label>Kategori</label>
          <input
            type="text"
            id="eKat"
            class="form-input"
            placeholder="Contoh: Sembako"
          />
        </div>
        <div class="form-group">
          <label>Nama Barang (Wajib)</label>
          <input
            type="text"
            id="eNama"
            class="form-input"
            placeholder="Contoh: Beras Super 5Kg"
          />
        </div>
        <div class="form-group" style="display: flex; gap: 10px">
          <div style="flex: 1; min-width: 0">
            <label>Harga Beli (Modal)</label>
            <input
              type="number"
              id="eBeli"
              class="form-input"
              placeholder="0"
            />
          </div>
          <div style="flex: 1; min-width: 0">
            <label>Satuan</label>
            <input
              type="text"
              id="eSat"
              class="form-input"
              placeholder="Pcs/Kg"
            />
          </div>
        </div>
        <div class="form-group">
          <label>Harga Jual (HPP ke Peserta)</label>
          <input
            type="number"
            id="eJual"
            class="form-input"
            placeholder="0"
            style="color: var(--primary); font-weight: bold"
          />
        </div>

        <button onclick="simpanBarang()" class="btn-full" id="btnSimpan">
          SIMPAN DATA
        </button>
      </div>
    </div>

    <script src="script.js"></script>
    <script>
      let allItems = [];
      let base64String = "";
      let fileMimeType = "";

      // Fungsi konversi link Drive ke Thumbnail
      function getSafeImageUrl(url) {
        if (!url) return "";
        const idMatch = url.match(/id=([^&]+)/);
        if (idMatch)
          return `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w400`;
        return url;
      }

      function formatRp(angka) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(angka || 0);
      }

      async function load() {
        const container = document.getElementById("listArea");
        const data = await fetchData("getBarang");

        if (Array.isArray(data)) {
          allItems = data;
          buatDropdownKategori();
          renderList(allItems);
        } else {
          container.innerHTML =
            '<div style="text-align:center; padding:20px; color:#ff6b6b;">Gagal memuat data.</div>';
        }
      }

      function buatDropdownKategori() {
        const categories = [
          ...new Set(allItems.map((item) => item.kategori)),
        ].filter(Boolean);
        const select = document.getElementById("catFilter");
        select.innerHTML = '<option value="">Semua Kategori</option>';
        categories.sort().forEach((c) => {
          select.innerHTML += `<option value="${c}">${c}</option>`;
        });
      }

      function filterLokal() {
        const qTeks = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const qKat = document.getElementById("catFilter").value.toLowerCase();
        const filtered = allItems.filter((item) => {
          return (
            item.nama.toLowerCase().includes(qTeks) &&
            (qKat === "" || (item.kategori || "").toLowerCase() === qKat)
          );
        });
        renderList(filtered);
      }

      function renderList(items) {
        const container = document.getElementById("listArea");
        container.innerHTML = "";

        if (items.length === 0) {
          container.innerHTML =
            '<div style="text-align:center; padding:40px; color:#666;"><i class="fas fa-box-open" style="font-size:2rem; margin-bottom:10px;"></i><br>Tidak ada data.</div>';
          return;
        }

        let html = "";
        items.forEach((b) => {
          let safeUrl = getSafeImageUrl(b.foto);
          let imgHtml = safeUrl
            ? `<img src="${safeUrl}">`
            : `<i class="fas fa-image" style="font-size:1.5rem; color:#444;"></i>`;

          let infoPaket =
            b.dipakai && b.dipakai.length > 0
              ? `<div class="used-in"><b><i class="fas fa-link"></i> Terikat di:</b> ${b.dipakai.map((p) => `<span class="hl">${p}</span>`).join(", ")}</div>`
              : `<div class="used-in" style="border-color:#444;">Barang Bebas (Belum masuk resep paket).</div>`;

          // Encode data agar aman dipassing via HTML String
          let bData = encodeURIComponent(JSON.stringify(b));

          html += `
            <div class="item-card">
                <button class="btn-del-mini" onclick="hapus('${b.nama}')"><i class="fas fa-trash"></i></button>
                <div class="item-img">${imgHtml}</div>
                <div class="item-info">
                    <div class="item-top">
                        <h4 class="item-name">${b.nama}</h4>
                    </div>
                    <span class="badge-cat">${b.kategori || "Tanpa Kategori"}</span>
                    
                    ${infoPaket}

                    <div class="price-grid">
                        <div class="p-box">
                            <span class="p-label">Modal (Beli)</span>
                            <span class="p-val">${formatRp(b.hargaBeli)}</span>
                        </div>
                        <div class="p-box" style="border-color:rgba(255,215,0,0.3);">
                            <span class="p-label">HPP (Jual)</span>
                            <span class="p-val jual">${formatRp(b.hargaJual)}</span>
                        </div>
                    </div>

                    <button class="btn-edit-full" onclick="bukaModalEdit('${bData}')">
                        <i class="fas fa-edit"></i> Edit Barang
                    </button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
      }

      // --- LOGIKA HAPUS ---
      async function hapus(nm) {
        if (!confirm(`Yakin HAPUS barang "${nm}" secara permanen?`)) return;
        const res = await fetchData("hapusBarangAdmin", { nama: nm }, "POST");
        if (res && res.success) load();
        else alert("Gagal menghapus");
      }

      // --- LOGIKA MODAL FORM (TAMBAH & EDIT) ---
      function bukaModalEdit(dataStr) {
        // Reset Preview
        base64String = "";
        fileMimeType = "";
        document.getElementById("fileInput").value = "";
        document.getElementById("fotoPreview").style.display = "none";
        document.getElementById("fotoPreview").src = "";
        document.getElementById("fotoPlaceholder").style.display = "block";

        if (dataStr) {
          // MODE EDIT
          let b = JSON.parse(decodeURIComponent(dataStr));
          document.getElementById("mTitle").innerText = "Edit: " + b.nama;
          document.getElementById("eNamaLama").value = b.nama;
          document.getElementById("eKat").value = b.kategori || "";
          document.getElementById("eNama").value = b.nama;
          document.getElementById("eBeli").value = b.hargaBeli || 0;
          document.getElementById("eJual").value = b.hargaJual || 0;
          document.getElementById("eSat").value = b.satuan || "";

          if (b.foto) {
            let safeUrl = getSafeImageUrl(b.foto);
            document.getElementById("fotoPreview").src = safeUrl;
            document.getElementById("fotoPreview").style.display = "block";
            document.getElementById("fotoPlaceholder").style.display = "none";
          }
        } else {
          // MODE TAMBAH BARU
          document.getElementById("mTitle").innerText = "Tambah Barang Baru";
          document.getElementById("eNamaLama").value = "";
          document.getElementById("eKat").value = "";
          document.getElementById("eNama").value = "";
          document.getElementById("eBeli").value = "";
          document.getElementById("eJual").value = "";
          document.getElementById("eSat").value = "";
        }

        document.getElementById("modalForm").style.display = "flex";
      }

      function tutupModal() {
        document.getElementById("modalForm").style.display = "none";
      }

      // --- LOGIKA UPLOAD PREVIEW ---
      function previewImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) return alert("Maksimal gambar 2MB!");
        fileMimeType = file.type;
        const reader = new FileReader();
        reader.onload = function (e) {
          base64String = e.target.result;
          document.getElementById("fotoPreview").src = base64String;
          document.getElementById("fotoPreview").style.display = "block";
          document.getElementById("fotoPlaceholder").style.display = "none";
        };
        reader.readAsDataURL(file);
      }

      // --- LOGIKA SIMPAN ---
      async function simpanBarang() {
        const namaLama = document.getElementById("eNamaLama").value;
        const payload = {
          namaLama: namaLama, // Jika kosong, Backend otomatis membuat Barang Baru
          kategori: document.getElementById("eKat").value,
          namaBaru: document.getElementById("eNama").value,
          hargaBeli: document.getElementById("eBeli").value || 0,
          hargaJual: document.getElementById("eJual").value || 0,
          satuan: document.getElementById("eSat").value,
          base64: base64String,
          mimeType: fileMimeType,
        };

        if (!payload.namaBaru) return alert("Nama barang wajib diisi!");

        const btn = document.getElementById("btnSimpan");
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        btn.disabled = true;

        const res = await fetchData("editBarangAdmin", payload, "POST");

        if (res && res.success) {
          tutupModal();
          load();
        } else {
          alert(
            "Gagal menyimpan data: " + (res ? res.error : "Koneksi bermasalah"),
          );
        }

        btn.innerHTML = "SIMPAN DATA";
        btn.disabled = false;
      }

      load();
    </script>
  </body>
</html>
